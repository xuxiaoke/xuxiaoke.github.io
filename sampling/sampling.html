<!DOCTYPE html>
<head>
<meta charset="utf-8">
  <meta name="author" content="大连民族学院 许小可" />
  <title>大规模社交网络的抽样及其应用</title>
<link href='http://fonts.googleapis.com/css?family=Oswald' rel='stylesheet'>
<style>
  html { background-color: black; }
  body { background-color: white; border-radius: 12px}
  /* A section is a slide. It's size is 800x600, and this will never change */
  section {
      font-family: 'Oswald', arial, serif;
      font-size: 20pt;
    }
  address, blockquote, dl, fieldset, form, h1, h2, h3, h4, h5, h6, hr, ol, p, pre, table, ul, dl { padding: 10px 20px 10px 20px; }
  h1, h2, h3 {
    text-align: center;
    margin: 10pt 10pt 20pt 10pt;
  }
  ul, ol {
    margin: 10px 10px 10px 50px;
  }
  section.titleslide h1 { margin-top: 200px; }
  h1.title { margin-top: 150px; }
  h1 { font-size: 180%; }
  h2 { font-size: 120%; }
  h3 { font-size: 100%; }
  q { quotes: "“" "”" "‘" "’"; }
  blockquote, q {
    display: block;
    width: 90%;
    height: 100%;
    background-color: black;
    color: white;
    padding: 50px;
  }

  /* Figures are displayed full-page, with the caption on
     top of the image/video */
  figure {
    background-color: black;
	vertical-align: middle;
  }
  img {
    max-width: 100%;
	text-align: center;
	margin:0 auto; 
  }
  figcaption {
    margin: 70px;
  }
  pre {
    max-width: 100%;
    max-height: 380px;
    overflow: auto;
  }
  footer {
    position: absolute;
    bottom: 0;
    width: 100%;
    padding: 40px;
    text-align: right;
    background-color: #F3F4F8;
    border-top: 1px solid #CCC;
  }

  /* Transition effect */
  /* Feel free to change the transition effect for original
     animations. See here:
     https://developer.mozilla.org/en/CSS/CSS_transitions
     How to use CSS3 Transitions: */
  section {
      -moz-transition: left 400ms linear 0s;
      -webkit-transition: left 400ms linear 0s;
      -ms-transition: left 400ms linear 0s;
      transition: left 400ms linear 0s;
  }

  /* Before */
  section { left: -150%; }
  /* Now */
  section[aria-selected] { left: 0; }
  /* After */
  section[aria-selected] ~ section { left: +150%; }

  /* Incremental elements */

  /* By default, visible */
  .incremental > * { opacity: 1; }

  /* The current item */
  .incremental > *[aria-selected] { color: red; opacity: 1; }

  /* The items to-be-selected */
  .incremental > *[aria-selected] ~ * { opacity: 0.2; }
</style>
</head>
<body>
<section>
  <h1 class="title">大规模社交网络的抽样及其应用</h1>
  <h2 class="author">大连民族学院 许小可</h2>
  <h3 class="date">2013/04/10</h3>
</section>
<section id="为什么要抽样" class="slide level1">
<h1>为什么要抽样</h1>
<ul class="incremental">
<li><p>数据量太大，获得总体数据比较困难或代价很高</p></li>
<li><p>厂商为了保护用户隐私和商业秘密不愿意提供总体数据</p></li>
<li><p>即使能得到总体数据，研究者处理起来也很困难</p></li>
<li><p>能否从总体中取出一些样本来进行分析和研究</p></li>
<li><p>抽样是社会学研究中最常用的技术和手段</p></li>
</ul>
</section>
<section id="抽样的定义和好处" class="slide level1">
<h1>抽样的定义和好处</h1>
<p>在统计学中，抽样（Sampling）是一种推论统计方法，它是指从目标总体（Population，或称为母体）中抽取一部分个体作为样本（Sample），通过观察样本的某一或某些属性，依据所获得的数据对总体的数量特征得出具有一定可靠性的估计判断，从而达到对总体的认识。</p>
<ul class="incremental">
<li><p>获取数据代价比较小：尤其对于破坏性检测</p></li>
<li><p>可有效保护用户隐私和商业秘密</p></li>
<li><p>数据量小，容易存储和处理</p></li>
</ul>
</section>
<section id="案例全国1人口抽样调查" class="slide level1">
<h1>案例：全国<span class="math">1%</span>人口抽样调查</h1>
<div style="text-align:center;">
<img src="OSNfigures/chouyang/chouyang1.jpg" alt="替代文本" title="标题文本" width="580" margin:0 auto />
</div>

<p>参考：<a href="http://news.xinhuanet.com/politics/2006-08/26/content_5009832.htm">http://news.xinhuanet.com/politics/2006-08/26/content_5009832.htm</a></p>
</section>
<section id="复杂系统和复杂网络" class="slide level1">
<h1>复杂系统和复杂网络</h1>
<p>复杂网络是对复杂系统的抽象和描述方式，任何包含大量组成单元（或子系统）的复杂系统，当把构成单元抽象成节点、单元之间的相互关系抽象为边时，都可以当作复杂网络来研究。</p>
<div style="text-align:center;">
<img src="OSNfigures/chouyang/network1.png" alt="替代文本" title="标题文本" width="600" margin:0 auto />
</div>

</section>
<section id="各种不同领域的复杂网络" class="slide level1">
<h1>各种不同领域的复杂网络</h1>
<ul class="incremental">
<li><p>信息网络：WWW，Internet，Email网络</p></li>
<li><p>技术网络：电力网，论文引用网，电话线路网</p></li>
<li><p>交通运输网：航线网，铁路网，公路网，自然河流网</p></li>
<li><p>生物网：食物链网，神经网，蛋白质网，基因网络</p></li>
<li><p>社会网：演员合作网，友谊网，婚恋网，科研合作网</p></li>
</ul>
</section>
<section id="由复杂网络分析时间序列特性" class="slide level1">
<h1>由复杂网络分析时间序列特性</h1>
<div style="text-align:center;">
<img src="OSNfigures/chouyang/timeseries1.png" alt="替代文本" title="标题文本" width="600" margin:0 auto />
</div>

</section>
<section id="复杂系统进行抽样的困难" class="slide level1">
<h1>复杂系统进行抽样的困难</h1>
<div style="text-align:center;">
<img src="OSNfigures/chouyang/elephant1.jpg" alt="替代文本" title="标题文本" width="800" />
</div>

</section>
<section id="复杂网络抽样的困难" class="slide level1">
<h1>复杂网络抽样的困难</h1>
<p>每个人的身高、体重、财产进行抽样时只依赖于<strong>个体本身</strong>；而对每个人的朋友数量进行抽样的时候，不但依赖于个体也依赖于<strong>和他发生关系的个体</strong>，小范围和大范围的抽样结果相差很大。</p>
<ul class="incremental">
<li><p>无法进行随机抽样：很难找到有效的样本空间</p></li>
<li><p>亚里士多德：整体大于部分之和</p></li>
<li><p>more is different：个体之间存在依赖性</p></li>
<li><p>很强的时变特性：网络结构、节点活跃特性动态变化快</p></li>
</ul>
</section>
<section id="传统社交网络小样本精细研究" class="slide level1">
<h1>传统社交网络：小样本精细研究</h1>
<div style="text-align:center;">
<img src="OSNfigures/chouyang/four_structures.png" alt="替代文本" title="标题文本" width="600" margin:0 auto />
</div>

</section>
<section id="online-social-networks-and-mideas" class="slide level1">
<h1>Online Social networks and Mideas</h1>
<ul class="incremental">
<li><p>人人网</p></li>
<li><p>新浪微博</p></li>
<li><p>QQ、微信、陌陌</p></li>
<li><p>facebook</p></li>
<li><p>Twitter</p></li>
<li><p>Google+</p></li>
<li><p>用户数量太大！！！！</p></li>
</ul>
</section>
<section id="在线社交网络上的抽样问题" class="slide level1">
<h1>在线社交网络上的抽样问题</h1>
<p>从社交媒体（新浪微博、Twitter）或社交网站（Facebook、人人网）上中抽取一部分个体作为样本（Sample），依据所获得的样本集合的属性来推断总体的宏观统计特性：</p>
<ul class="incremental">
<li><p>平均度：用户平均有多少个朋友</p></li>
<li><p>聚类系数：用户的朋友之间相互之朋友的概率</p></li>
<li><p>匹配系数：用户是否倾向于和自己性质差不多的人交朋友</p></li>
<li><p>用户的总量和每个月新增用户的数量</p></li>
<li><p>用户的活跃度</p></li>
</ul>
</section>
<section id="常见的社交网络抽样方法" class="slide level1">
<h1>常见的社交网络抽样方法</h1>
<div style="text-align:center;">
<img src="OSNfigures/chouyang/family_tree.png" alt="替代文本" title="标题文本" width="540" />
</div>

<ul class="incremental">
<li><p>直接抽样方法：针对节点或连边的简单随机抽样方法</p></li>
<li><p>间接抽样方法：基于网络链接关系进行抽样的方法</p></li>
</ul>
</section>
<section id="针对节点的简单随机抽样法" class="slide level1">
<h1>针对节点的简单随机抽样法</h1>
<div style="text-align:center;">
<img src="OSNfigures/chouyang/randomsampling.jpg" alt="替代文本" title="标题文本" width="450" />
</div>

</section>
<section id="常见的网络遍历方式抽样" class="slide level1">
<h1>常见的网络遍历方式抽样</h1>
<ul class="incremental">
<li><p>宽（广）度优先搜索，也可以叫滚雪球抽样</p></li>
<li><p>深度优先搜索</p></li>
<li><p>森林火灾方式 (Forest Fire)</p></li>
<li><p>应答驱动抽样 (Respondent-Driven Sampling)</p></li>
<li><p>基于随机游走的抽样</p></li>
</ul>
</section>
<section id="宽度优先搜索抽样法-滚雪球" class="slide level1">
<h1>宽度优先搜索抽样法-滚雪球</h1>
<div style="text-align:center;">
<img src="OSNfigures/chouyang/BFSsampling.jpg" alt="替代文本" title="标题文本" width="650" />
</div>

</section>
<section id="应答驱动抽样-rds" class="slide level1">
<h1>应答驱动抽样-RDS</h1>
<div style="text-align:center;">
<img src="OSNfigures/chouyang/RDSfigure.gif" alt="替代文本" title="标题文本" width="550" />
</div>

</section>
<section id="无偏随机游走抽样法" class="slide level1">
<h1>无偏随机游走抽样法</h1>
<div style="text-align:center;">
<img src="OSNfigures/chouyang/RWsampling.jpg" alt="替代文本" title="标题文本" width="450" />
</div>

<p>简单随机游走抽样法偏向于抽取度大节点：抽取概率和节点度成正比。</p>
</section>
<section id="为什么你朋友的好友比你多" class="slide level1">
<h1>为什么你朋友的好友比你多?</h1>
<div style="text-align:center;">
<img src="OSNfigures/chouyang/newfigure.png" alt="替代文本" title="标题文本" width="750" />
</div>

<p>[1]: S. L. Feld, Why your friends have more friends than you do, American Journal of Sociology, Vol. 96, No. 6 (May 1991), pp. 1464–1477.</p>
</section>
<section id="mh有偏随机游走抽样法" class="slide level1">
<h1>MH有偏随机游走抽样法</h1>
<div style="text-align:center;">
<img src="OSNfigures/chouyang/MHRWsampling.jpg" alt="替代文本" title="标题文本" width="650" />
</div>

<p>MHRW方法在随机游走的时候以一定的概率偏向于度低的节点</p>
</section>
<section id="有偏随机行走抽样" class="slide level1">
<h1>有偏随机行走抽样</h1>
<div style="text-align:center;">
<img src="OSNfigures/chouyang/BRWsampling.png" alt="替代文本" title="标题文本" width="650" />
</div>

</section>
<section id="使用哪些统计量来衡量抽样效果" class="slide level1">
<h1>使用哪些统计量来衡量抽样效果</h1>
<div style="text-align:center;">
<img src="OSNfigures/chouyang/statistics.png" alt="替代文本" title="标题文本" width="750" />
</div>

<p>[1] 平均度：Mean Degree [2] 聚类系数: Clustering Coefficient [3] 匹配细数：Assortativity Coefficient</p>
</section>
<section id="我们的待抽样数据" class="slide level1">
<h1>我们的待抽样数据</h1>
<div style="text-align:center;">
<img src="OSNfigures/chouyang/data1.jpg" alt="替代文本" title="标题文本" width="630" />
</div>

</section>
<section id="社交网络上新的有用信息" class="slide level1">
<h1>社交网络上新的有用信息</h1>
<div style="text-align:center;">
<img src="OSNfigures/chouyang/renren1.jpg" alt="替代文本" title="标题文本" width="650" />
</div>

</section>
<section id="节点的两个度信息内部vs外部" class="slide level1">
<h1>节点的两个度信息：内部VS外部</h1>
<div style="text-align:center;">
<img src="OSNfigures/chouyang/networkshow1.jpg" alt="替代文本" title="标题文本" width="780" />
</div>

</section>
<section id="平均度mean-degree" class="slide level1">
<h1>平均度：Mean Degree</h1>
<div style="text-align:center;">
<img src="OSNfigures/chouyang/degree.png" alt="替代文本" title="标题文本" width="650" />
</div>

</section>
<section id="聚类系数clustering-coefficient" class="slide level1">
<h1>聚类系数Clustering Coefficient</h1>
<div style="text-align:center;">
<img src="OSNfigures/chouyang/cluster.png" alt="替代文本" title="标题文本" width="630" />
</div>

</section>
<section id="匹配性assortativity-coefficient" class="slide level1">
<h1>匹配性Assortativity Coefficient</h1>
<div style="text-align:center;">
<img src="OSNfigures/chouyang/AS.png" alt="替代文本" title="标题文本" width="650" />
</div>

</section>
<section id="偏向小度节点alpha-1的结果分析" class="slide level1">
<h1>偏向小度节点<span class="math"><em>α</em> =  − 1</span>的结果分析</h1>
<div style="text-align:center;">
<p><img src="OSNfigures/chouyang/negative1.png" alt="替代文本" title="标题文本" width="750" /></p>
</section>
<section id="所用户最多高校情况分析" class="slide level1">
<h1>10所用户最多高校情况分析</h1>
<div style="text-align:center;">
<p><img src="OSNfigures/chouyang/university10.png" alt="替代文本" title="标题文本" width="500" /></p>
</section>
<section id="研究小结" class="slide level1">
<h1>研究小结</h1>
<ul class="incremental">
<li><p>系统分析了用户个体的两个度信息对于常用复杂网络抽样方法的影响</p></li>
<li><p>综合比较各种抽样方法的结果，在利用用户度信息的情况下，发现偏向度小节点的有偏随机行走方式是比较有效的抽样方式</p></li>
<li><p>研究了基于用户大学信息的抽样网络，分析了两种情况下抽样网络的的边界效应和系统性偏差</p></li>
</ul>
</section>
<section id="正在做的工作" class="slide level1">
<h1>正在做的工作</h1>
<ul class="incremental">
<li><p>不需知道所有邻居信息，仅使用被抽样节点的信息</p></li>
<li><p>自适应选择最优<span class="math"><em>α</em></span>的抽样方法</p></li>
<li><p>社交网络行为数据的抽样方法</p></li>
</ul>
</section>
<section id="抽样的思考和典型应用" class="slide level1">
<h1>抽样的思考和典型应用</h1>
<ul class="incremental">
<li><p>大数据分析时代需要抽样吗？</p></li>
<li><p>如何使用抽样来估计总体的数量</p></li>
<li><p>抽样对于信息传播的影响</p></li>
<li><p>抽样对于链路预测的影响</p></li>
<li><p>抽样对社团结构检测的影响</p></li>
<li><p>。。。。。。。。。</p></li>
</ul>
</section>
<section id="大数据分析和抽样并不矛盾" class="slide level1">
<h1>大数据分析和抽样并不矛盾</h1>
<ul class="incremental">
<li><p>分布式(map-reduce）计算技术的发展</p></li>
<li><p>实时处理（流计算，内存计算）的发展</p></li>
<li><p>总体数据分析成为可能</p></li>
<li><p>从效率和成本的角度考虑，适当理的抽样是必要的</p></li>
<li><p>再大的数据绝大多数其实还是抽样数据</p></li>
</ul>
</section>
<section id="使用抽样来估计总体的数量" class="slide level1">
<h1>使用抽样来估计总体的数量</h1>
<ul class="incremental">
<li><p>二战时德军坦克数量估计</p></li>
<li><p>种群密度的常用调查方法：标志重捕法</p></li>
<li><p>使用标志重捕法追踪美元研究人类动力学和疾病传播</p></li>
<li><p>估计自然界中物种的数量：极大似然估计法</p></li>
<li><p>估计社交网络的用户数量</p></li>
<li><p>新问题：很活跃用户的总体数量是多少？</p></li>
</ul>
</section>
<section id="重捕获边vs重捕获节点" class="slide level1">
<h1>重捕获边VS重捕获节点</h1>
<div style="text-align:center;">
<p><img src="OSNfigures/chouyang/IE_edges.png" alt="替代文本" title="标题文本" width="540" /></p>
<p>[1] Kurant M, Butts C T, Markopoulou A. Graph Size Estimation[J]. arXiv preprint arXiv:1210.0460, 2012.</p>
</section>
<section id="信息传播的拓扑结构" class="slide level1">
<h1>信息传播的拓扑结构</h1>
<div style="text-align:center;">
<p><img src="OSNfigures/chouyang/diffusion.jpg" alt="替代文本" title="标题文本" width="580" /></p>
<p>[1] Munmun De Choudhury, Yu-Ru Lin, Hari Sundaram,K. Selcuk Candan, Lexing Xie, Aisling Kelliher,How Does the Data Sampling Strategy Impact the Discovery of Information Diffusion in Social Media? Proceedings of the Fourth International AAAI Conference on Weblogs and Social Media,2010.</p>
</section>
<section id="抽样方法对于信息传播的影响1" class="slide level1">
<h1>抽样方法对于信息传播的影响1</h1>
<div style="text-align:center;">
<p><img src="OSNfigures/chouyang/diffusion1.bmp" alt="替代文本" title="标题文本" width="560" /></p>
</section>
<section id="抽样方法对于信息传播的影响2" class="slide level1">
<h1>抽样方法对于信息传播的影响2</h1>
<div style="text-align:center;">
<p><img src="OSNfigures/chouyang/diffusion2.bmp" alt="替代文本" title="标题文本" width="560" /></p>
</section>
<section id="链路预测的基本思想" class="slide level1">
<h1>链路预测的基本思想</h1>
<div style="text-align:center;">
<p><img src="OSNfigures/chouyang/link_prediction.png" alt="替代文本" title="标题文本" width="700" /></p>
</section>
<section id="抽样对于链路预测方法的影响" class="slide level1">
<h1>抽样对于链路预测方法的影响</h1>
<div style="text-align:center;">
<p><img src="OSNfigures/chouyang/prediction_results.png" alt="替代文本" title="标题文本" width="680" /></p>
<p>[1]Jichang Zhao, Xu Feng, Li Dong, Xiao Liang and Ke Xu. Performance of local information-based link prediction: a sampling perspective, J. Phys. A: Math. Theor. 45 (2012) 345001</p>
</section>
<section id="总结抽样无处不在" class="slide level1">
<h1>总结：抽样无处不在</h1>
<ul class="incremental">
<li><p>数据无处不在：data，data，data</p></li>
<li><p>有数据就有意味着可以试试抽样</p></li>
<li><p>未来社交网络的研究一定要使用抽样技术</p></li>
<li><p>数据的力量需要抽样技术的发展来体现</p></li>
</ul>
</section>
<section id="传统社会学小而精致" class="slide level1">
<h1>传统社会学：小而精致</h1>
<div style="text-align:center;">
<p><img src="OSNfigures/chouyang/small_work.png" alt="替代文本" title="标题文本" width="600" align="middle" /></p>
</section>
<section id="系统科学研究大而粗糙" class="slide level1">
<h1>系统科学研究：大而粗糙</h1>
<div style="text-align:center;">
<p><img src="OSNfigures/chouyang/large_work.png" alt="替代文本" title="标题文本" width="600" align="middle" /></p>
</section>
<section id="期待学科融合大而精致的研究" class="slide level1">
<h1>期待学科融合：大而精致的研究</h1>
<div style="text-align:center;">
<p><img src="OSNfigures/chouyang/rossler.png" alt="替代文本" title="标题文本" width="500" align="middle" /></p>
<p>homepage：<a href="http://www.eie.polyu.edu.hk/~xuxk/">http://www.eie.polyu.edu.hk/~xuxk/</a></p>
<p>E-mail：<a href="xiaokeeie@gmail.com">xiaokeeie@gmail.com</a></p>
</section>
<section id="问题和讨论" class="slide level1">
<h1>问题和讨论</h1>
<div style="text-align:center;">
<p><img src="OSNfigures/chouyang/wenhao1.jpg" alt="替代文本" title="标题文本" width="500" align="middle" /></p>
</section>
<!-- {{{{ dzslides core
#
#
#     __  __  __       .  __   ___  __
#    |  \  / /__` |    | |  \ |__  /__`
#    |__/ /_ .__/ |___ | |__/ |___ .__/ core :€
#
#
# The following block of code is not supposed to be edited.
# But if you want to change the behavior of these slides,
# feel free to hack it!
#
-->

<div id="progress-bar"></div>

<!-- Default Style -->
<style>
  * { margin: 0; padding: 0; -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box; }
  details { display: none; }
  body {
    width: 800px; height: 600px;
    margin-left: -400px; margin-top: -300px;
    position: absolute; top: 50%; left: 50%;
    overflow: hidden;
  }
  section {
    position: absolute;
    pointer-events: none;
    width: 100%; height: 100%;
  }
  section[aria-selected] { pointer-events: auto; }
  html { overflow: hidden; }
  body { display: none; }
  body.loaded { display: block; }
  .incremental {visibility: hidden; }
  .incremental[active] {visibility: visible; }
  #progress-bar{
    bottom: 0;
    position: absolute;
    -moz-transition: width 400ms linear 0s;
    -webkit-transition: width 400ms linear 0s;
    -ms-transition: width 400ms linear 0s;
    transition: width 400ms linear 0s;
  }
  figure {
    width: 100%;
    height: 100%;
  }
  figure > * {
    position: absolute;
  }
  figure > img, figure > video {
    width: 100%; height: 100%;
  }
</style>

<script>
  var Dz = {
    remoteWindows: [],
    idx: -1,
    step: 0,
    slides: null,
    progressBar : null,
    params: {
      autoplay: "1"
    }
  };

  Dz.init = function() {
    document.body.className = "loaded";
    this.slides = $$("body > section");
    this.progressBar = $("#progress-bar");
    this.setupParams();
    this.onhashchange();
    this.setupTouchEvents();
    this.onresize();
  }
  
  Dz.setupParams = function() {
    var p = window.location.search.substr(1).split('&');
    p.forEach(function(e, i, a) {
      var keyVal = e.split('=');
      Dz.params[keyVal[0]] = decodeURIComponent(keyVal[1]);
    });
  // Specific params handling
    if (!+this.params.autoplay)
      $$.forEach($$("video"), function(v){ v.controls = true });
  }

  Dz.onkeydown = function(aEvent) {
    // Don't intercept keyboard shortcuts
    if (aEvent.altKey
      || aEvent.ctrlKey
      || aEvent.metaKey
      || aEvent.shiftKey) {
      return;
    }
    if ( aEvent.keyCode == 37 // left arrow
      || aEvent.keyCode == 38 // up arrow
      || aEvent.keyCode == 33 // page up
    ) {
      aEvent.preventDefault();
      this.back();
    }
    if ( aEvent.keyCode == 39 // right arrow
      || aEvent.keyCode == 40 // down arrow
      || aEvent.keyCode == 34 // page down
    ) {
      aEvent.preventDefault();
      this.forward();
    }
    if (aEvent.keyCode == 35) { // end
      aEvent.preventDefault();
      this.goEnd();
    }
    if (aEvent.keyCode == 36) { // home
      aEvent.preventDefault();
      this.goStart();
    }
    if (aEvent.keyCode == 32) { // space
      aEvent.preventDefault();
      this.toggleContent();
    }
    if (aEvent.keyCode == 70) { // f
      aEvent.preventDefault();
      this.goFullscreen();
    }
  }

  /* Touch Events */

  Dz.setupTouchEvents = function() {
    var orgX, newX;
    var tracking = false;

    var db = document.body;
    db.addEventListener("touchstart", start.bind(this), false);
    db.addEventListener("touchmove", move.bind(this), false);

    function start(aEvent) {
      aEvent.preventDefault();
      tracking = true;
      orgX = aEvent.changedTouches[0].pageX;
    }

    function move(aEvent) {
      if (!tracking) return;
      newX = aEvent.changedTouches[0].pageX;
      if (orgX - newX > 100) {
        tracking = false;
        this.forward();
      } else {
        if (orgX - newX < -100) {
          tracking = false;
          this.back();
        }
      }
    }
  }

  /* Adapt the size of the slides to the window */

  Dz.onresize = function() {
    var db = document.body;
    var sx = db.clientWidth / window.innerWidth;
    var sy = db.clientHeight / window.innerHeight;
    var transform = "scale(" + (1/Math.max(sx, sy)) + ")";

    db.style.MozTransform = transform;
    db.style.WebkitTransform = transform;
    db.style.OTransform = transform;
    db.style.msTransform = transform;
    db.style.transform = transform;
  }


  Dz.getDetails = function(aIdx) {
    var s = $("section:nth-of-type(" + aIdx + ")");
    var d = s.$("details");
    return d ? d.innerHTML : "";
  }

  Dz.onmessage = function(aEvent) {
    var argv = aEvent.data.split(" "), argc = argv.length;
    argv.forEach(function(e, i, a) { a[i] = decodeURIComponent(e) });
    var win = aEvent.source;
    if (argv[0] === "REGISTER" && argc === 1) {
      this.remoteWindows.push(win);
      this.postMsg(win, "REGISTERED", document.title, this.slides.length);
      this.postMsg(win, "CURSOR", this.idx + "." + this.step);
      return;
    }
    if (argv[0] === "BACK" && argc === 1)
      this.back();
    if (argv[0] === "FORWARD" && argc === 1)
      this.forward();
    if (argv[0] === "START" && argc === 1)
      this.goStart();
    if (argv[0] === "END" && argc === 1)
      this.goEnd();
    if (argv[0] === "TOGGLE_CONTENT" && argc === 1)
      this.toggleContent();
    if (argv[0] === "SET_CURSOR" && argc === 2)
      window.location.hash = "#" + argv[1];
    if (argv[0] === "GET_CURSOR" && argc === 1)
      this.postMsg(win, "CURSOR", this.idx + "." + this.step);
    if (argv[0] === "GET_NOTES" && argc === 1)
      this.postMsg(win, "NOTES", this.getDetails(this.idx));
  }

  Dz.toggleContent = function() {
    // If a Video is present in this new slide, play it.
    // If a Video is present in the previous slide, stop it.
    var s = $("section[aria-selected]");
    if (s) {
      var video = s.$("video");
      if (video) {
        if (video.ended || video.paused) {
          video.play();
        } else {
          video.pause();
        }
      }
    }
  }

  Dz.setCursor = function(aIdx, aStep) {
    // If the user change the slide number in the URL bar, jump
    // to this slide.
    aStep = (aStep != 0 && typeof aStep !== "undefined") ? "." + aStep : ".0";
    window.location.hash = "#" + aIdx + aStep;
  }

  Dz.onhashchange = function() {
    var cursor = window.location.hash.split("#"),
        newidx = 1,
        newstep = 0;
    if (cursor.length == 2) {
      newidx = ~~cursor[1].split(".")[0];
      newstep = ~~cursor[1].split(".")[1];
      if (newstep > Dz.slides[newidx - 1].$$('.incremental > *').length) {
        newstep = 0;
        newidx++;
      }
    }
    this.setProgress(newidx, newstep);
    if (newidx != this.idx) {
      this.setSlide(newidx);
    }
    if (newstep != this.step) {
      this.setIncremental(newstep);
    }
    for (var i = 0; i < this.remoteWindows.length; i++) {
      this.postMsg(this.remoteWindows[i], "CURSOR", this.idx + "." + this.step);
    }
  }

  Dz.back = function() {
    if (this.idx == 1 && this.step == 0) {
      return;
    }
    if (this.step == 0) {
      this.setCursor(this.idx - 1,
                     this.slides[this.idx - 2].$$('.incremental > *').length);
    } else {
      this.setCursor(this.idx, this.step - 1);
    }
  }

  Dz.forward = function() {
    if (this.idx >= this.slides.length &&
        this.step >= this.slides[this.idx - 1].$$('.incremental > *').length) {
        return;
    }
    if (this.step >= this.slides[this.idx - 1].$$('.incremental > *').length) {
      this.setCursor(this.idx + 1, 0);
    } else {
      this.setCursor(this.idx, this.step + 1);
    }
  }

  Dz.goStart = function() {
    this.setCursor(1, 0);
  }

  Dz.goEnd = function() {
    var lastIdx = this.slides.length;
    var lastStep = this.slides[lastIdx - 1].$$('.incremental > *').length;
    this.setCursor(lastIdx, lastStep);
  }

  Dz.setSlide = function(aIdx) {
    this.idx = aIdx;
    var old = $("section[aria-selected]");
    var next = $("section:nth-of-type("+ this.idx +")");
    if (old) {
      old.removeAttribute("aria-selected");
      var video = old.$("video");
      if (video) {
        video.pause();
      }
    }
    if (next) {
      next.setAttribute("aria-selected", "true");
      var video = next.$("video");
      if (video && !!+this.params.autoplay) {
        video.play();
      }
    } else {
      // That should not happen
      this.idx = -1;
      // console.warn("Slide doesn't exist.");
    }
  }

  Dz.setIncremental = function(aStep) {
    this.step = aStep;
    var old = this.slides[this.idx - 1].$('.incremental > *[aria-selected]');
    if (old) {
      old.removeAttribute('aria-selected');
    }
    var incrementals = $$('.incremental');
    if (this.step <= 0) {
      $$.forEach(incrementals, function(aNode) {
        aNode.removeAttribute('active');
      });
      return;
    }
    var next = this.slides[this.idx - 1].$$('.incremental > *')[this.step - 1];
    if (next) {
      next.setAttribute('aria-selected', true);
      next.parentNode.setAttribute('active', true);
      var found = false;
      $$.forEach(incrementals, function(aNode) {
        if (aNode != next.parentNode)
          if (found)
            aNode.removeAttribute('active');
          else
            aNode.setAttribute('active', true);
        else
          found = true;
      });
    } else {
      setCursor(this.idx, 0);
    }
    return next;
  }

  Dz.goFullscreen = function() {
    var html = $('html'),
        requestFullscreen = html.requestFullscreen || html.requestFullScreen || html.mozRequestFullScreen || html.webkitRequestFullScreen;
    if (requestFullscreen) {
      requestFullscreen.apply(html);
    }
  }
  
  Dz.setProgress = function(aIdx, aStep) {
    var slide = $("section:nth-of-type("+ aIdx +")");
    if (!slide)
      return;
    var steps = slide.$$('.incremental > *').length + 1,
        slideSize = 100 / (this.slides.length - 1),
        stepSize = slideSize / steps;
    this.progressBar.style.width = ((aIdx - 1) * slideSize + aStep * stepSize) + '%';
  }
  
  Dz.postMsg = function(aWin, aMsg) { // [arg0, [arg1...]]
    aMsg = [aMsg];
    for (var i = 2; i < arguments.length; i++)
      aMsg.push(encodeURIComponent(arguments[i]));
    aWin.postMessage(aMsg.join(" "), "*");
  }
  
  function init() {
    Dz.init();
    window.onkeydown = Dz.onkeydown.bind(Dz);
    window.onresize = Dz.onresize.bind(Dz);
    window.onhashchange = Dz.onhashchange.bind(Dz);
    window.onmessage = Dz.onmessage.bind(Dz);
  }

  window.onload = init;
</script>


<script> // Helpers
  if (!Function.prototype.bind) {
    Function.prototype.bind = function (oThis) {

      // closest thing possible to the ECMAScript 5 internal IsCallable
      // function 
      if (typeof this !== "function")
      throw new TypeError(
        "Function.prototype.bind - what is trying to be fBound is not callable"
      );

      var aArgs = Array.prototype.slice.call(arguments, 1),
          fToBind = this,
          fNOP = function () {},
          fBound = function () {
            return fToBind.apply( this instanceof fNOP ? this : oThis || window,
                   aArgs.concat(Array.prototype.slice.call(arguments)));
          };

      fNOP.prototype = this.prototype;
      fBound.prototype = new fNOP();

      return fBound;
    };
  }

  var $ = (HTMLElement.prototype.$ = function(aQuery) {
    return this.querySelector(aQuery);
  }).bind(document);

  var $$ = (HTMLElement.prototype.$$ = function(aQuery) {
    return this.querySelectorAll(aQuery);
  }).bind(document);

  $$.forEach = function(nodeList, fun) {
    Array.prototype.forEach.call(nodeList, fun);
  }

</script>
<!-- vim: set fdm=marker: }}} -->
</body>
</html>
